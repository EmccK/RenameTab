name: Build and Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version and date
        id: info
        run: |
          VERSION=$(jq -r .version manifest.json)
          DATE=$(date +'%Y%m%d')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT

      - name: Zip extension
        run: |
          zip -r rename-tab.zip . -x "*.git*" -x ".github/*" -x "*.md"

      - name: Delete old releases (keep latest and dated)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取所有 release
          RELEASES=$(gh release list --json tagName,createdAt --limit 100)

          # 删除旧的 latest release
          if gh release view latest &>/dev/null; then
            echo "Deleting old latest release..."
            gh release delete latest --yes --cleanup-tag || true
          fi

          # 删除旧的日期 release（只保留最新的一个）
          DATE_RELEASES=$(echo "$RELEASES" | jq -r '.[] | select(.tagName | startswith("v") and contains("-")) | .tagName' | sort -r)
          SKIP_FIRST=true
          for TAG in $DATE_RELEASES; do
            if [ "$SKIP_FIRST" = true ]; then
              SKIP_FIRST=false
              echo "Keeping dated release: $TAG"
              continue
            fi
            echo "Deleting old dated release: $TAG"
            gh release delete "$TAG" --yes --cleanup-tag || true
          done

      - name: Create latest release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create latest \
            --title "Latest Release (v${{ steps.info.outputs.version }})" \
            --notes "最新版本 v${{ steps.info.outputs.version }}

          构建时间: $(date +'%Y-%m-%d %H:%M:%S UTC')

          此 release 会在每次推送时自动更新。" \
            --latest \
            rename-tab.zip

      - name: Create dated release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ steps.info.outputs.version }}-${{ steps.info.outputs.date }}"

          # 检查是否已存在相同日期的 release
          if gh release view "$TAG" &>/dev/null; then
            echo "Dated release $TAG already exists, updating..."
            gh release delete "$TAG" --yes --cleanup-tag || true
          fi

          gh release create "$TAG" \
            --title "Release $TAG" \
            --notes "版本: v${{ steps.info.outputs.version }}
          日期: ${{ steps.info.outputs.date }}

          此为存档版本。" \
            rename-tab.zip#rename-tab-$TAG.zip
